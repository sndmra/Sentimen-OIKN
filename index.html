<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>IKN Sentiment Analysis Dashboard</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        "primary": "#c7a74a",
        "background-light": "#ffffff",
        "background-dark": "#1a1a1a",
        "text-light": "#333333",
        "text-dark": "#f0f0f0",
        "positive": "#28a745",
        "neutral": "#007bff",
        "negative": "#dc3545",
      },
      fontFamily: { "sans": ["Inter", "sans-serif"] },
      boxShadow: {
        'soft': '0 2px 10px rgba(0,0,0,0.05)',
        'hover': '0 6px 20px rgba(0,0,0,0.08)',
      },
    },
  },
}
</script>

<style>
body {
  animation: fadeIn 0.6s ease-in-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.material-symbols-outlined {
  font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
}

/* hover underline animasi elegan */
nav a {
  position: relative;
  transition: color 0.25s ease;
}
nav a::after {
  content: "";
  position: absolute;
  left: 0;
  bottom: -3px;
  width: 100%;
  height: 2px;
  background-color: #c7a74a;
  transform: scaleX(0);
  transform-origin: right;
  transition: transform 0.3s ease;
}
nav a:hover::after {
  transform: scaleX(1);
  transform-origin: left;
}

/* efek glow halus di gauge */
.group:hover .gauge-stroke {
  filter: drop-shadow(0 0 6px rgba(199, 167, 74, 0.6));
  stroke-width: 11;
  transition: all 0.3s ease;
}
.group:hover .material-symbols-outlined {
  filter: drop-shadow(0 0 4px rgba(199, 167, 74, 0.6));
}
</style>
</head>

<body class="bg-background-light dark:bg-background-dark font-sans text-text-light dark:text-text-dark">

<!-- ================= HEADER ================= -->
<header class="w-full bg-white dark:bg-background-dark border-b border-gray-200 dark:border-gray-700 shadow-sm">
  <div class="max-w-10xl mx-auto px-6 sm:px-8 lg:px-10 flex justify-between items-center py-5">

    <!-- Logo + title -->
    <div class="flex items-center space-x-4">
      <img alt="Logo IKN" width="80"
        src="https://upload.wikimedia.org/wikipedia/commons/2/2e/Logo_of_Ibu_Kota_Nusantara.svg"/>
      <div>
        <h1 class="text-2xl font-bold tracking-tight">Dashboard Analisis Persepsi Masyarakat di Media Sosial</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
          Dibuat oleh <span class="font-medium">Sean Daffa Damara</span> | Direktorat Data dan Kecerdasan Buatan
        </p>
      </div>
    </div>

    <!-- garis pemisah -->
    <div class="h-8 w-px bg-gray-300 mx-6"></div>

    <!-- Navigation -->
    <nav class="hidden md:flex items-center space-x-8">
      <a href="index.html" class="text-primary font-semibold text-sm">Dashboard</a>
      <a href="data.html" class="text-gray-600 hover:text-primary text-sm font-medium">Data</a>
      <a href="model.html" class="text-gray-600 hover:text-primary text-sm font-medium">Model</a>
      <a href="tentang.html" class="text-gray-600 hover:text-primary text-sm font-medium">Tentang</a>
    </nav>
  </div>
</header>

<!-- ================= MAIN CONTENT ================= -->
<main class="flex-1">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

    <!-- Filter -->
    <div class="flex flex-wrap items-center justify-between gap-4 mb-10 p-4 bg-background-light rounded-lg shadow-soft hover:shadow-hover transition">
      <div class="flex items-center gap-4">
        <div class="relative">
          <select id="sentimenFilter" class="h-10 rounded-lg bg-gray-100 border border-gray-200 pl-4 pr-8 text-sm font-medium focus:ring-primary focus:border-primary cursor-pointer">
            <option value="all">Semua Kategori</option>
            <option value="Positif">Positif</option>
            <option value="Netral">Netral</option>
            <option value="Negatif">Negatif</option>
          </select>
        </div>
        <div class="flex h-10 items-center gap-x-2 rounded-lg bg-gray-100 px-4 border border-gray-200">
          <span class="material-symbols-outlined text-base">calendar_today</span>
          <p class="text-sm font-medium">Periode Analisis</p>
          <input type="date" id="startDate" class="ml-2 bg-transparent border-none focus:ring-0 text-sm cursor-pointer">
          <span class="mx-1">â€“</span>
          <input type="date" id="endDate" class="bg-transparent border-none focus:ring-0 text-sm cursor-pointer">
        </div>
      </div>
      <button id="refreshBtn" class="flex items-center justify-center rounded-lg h-10 px-5 border-2 border-primary text-primary font-bold hover:bg-primary hover:text-white transition-all duration-300 cursor-pointer">
        <span>Perbarui Analisis</span>
      </button>
    </div>

    <!-- ============ INSIGHT SECTION ============ -->
    <section id="insightSection" class="mb-10">
      <h2 class="text-xl font-bold text-primary mb-4 flex items-center gap-2">
        <span class="material-symbols-outlined text-primary text-2xl">insights</span>
        Ringkasan Analitik
      </h2>

      <!-- Highlight Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div id="insightPos" class="bg-green-50 border border-green-200 rounded-lg p-4 shadow-soft">
          <p class="text-sm text-gray-600 font-medium mb-2">Perubahan Sentimen Positif</p>
          <h3 class="text-2xl font-bold text-green-600" id="posChange">+0%</h3>
          <p class="text-xs text-gray-500 mt-1" id="posNote">Stabil dibanding periode sebelumnya</p>
        </div>
        <div id="insightNet" class="bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-soft">
          <p class="text-sm text-gray-600 font-medium mb-2">Perubahan Sentimen Netral</p>
          <h3 class="text-2xl font-bold text-blue-600" id="netChange">+0%</h3>
          <p class="text-xs text-gray-500 mt-1" id="netNote">Stabil dibanding periode sebelumnya</p>
        </div>
        <div id="insightNeg" class="bg-red-50 border border-red-200 rounded-lg p-4 shadow-soft">
          <p class="text-sm text-gray-600 font-medium mb-2">Perubahan Sentimen Negatif</p>
          <h3 class="text-2xl font-bold text-red-600" id="negChange">+0%</h3>
          <p class="text-xs text-gray-500 mt-1" id="negNote">Stabil dibanding periode sebelumnya</p>
        </div>
      </div>

      <!-- Narrative Insight -->
      <div class="bg-background-light p-5 rounded-lg shadow-soft border-l-4 border-primary">
        <h3 class="text-base font-semibold text-gray-700 mb-2">ðŸ§© Hasil Analisis</h3>
        <p id="insightNarrative" class="text-sm text-gray-600 leading-relaxed">
          Memuat insight analitik otomatis berdasarkan perubahan data sentimen terkini.
        </p>
      </div>
    </section>

    <!-- Gauges -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
      <div id="gauge-pos" class="bg-background-light p-6 rounded-lg shadow-soft hover:shadow-hover flex flex-col items-center justify-center transition"></div>
      <div id="gauge-net" class="bg-background-light p-6 rounded-lg shadow-soft hover:shadow-hover flex flex-col items-center justify-center transition"></div>
      <div id="gauge-neg" class="bg-background-light p-6 rounded-lg shadow-soft hover:shadow-hover flex flex-col items-center justify-center transition"></div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-10">
      <div class="bg-background-light p-6 rounded-lg shadow-soft hover:shadow-hover transition">
        <h3 class="text-lg font-semibold text-primary mb-4">Distribusi Sentimen</h3>
        <div class="flex items-center justify-center h-[320px]">
          <canvas id="chart-sentimen" class="w-full h-full"></canvas>
        </div>
      </div>

      <div class="bg-background-light p-6 rounded-lg shadow-soft hover:shadow-hover transition">
        <h3 class="text-lg font-semibold text-primary mb-4">Jumlah Tweet per Kategori</h3>
        <div class="flex items-center justify-center h-[320px]">
          <canvas id="chart-bar" class="w-full h-full"></canvas>
        </div>
      </div>

      <div class="bg-background-light p-6 rounded-lg shadow-soft hover:shadow-hover transition">
        <h3 class="text-lg font-semibold text-primary mb-4">Tren Harian</h3>
        <div class="flex items-center justify-center h-[320px]">
          <canvas id="chart-trend" class="w-full h-full"></canvas>
        </div>
      </div>
    </div>

    <!-- Word Cloud -->
    <div class="bg-background-light p-6 rounded-lg shadow-soft hover:shadow-hover transition">
      <h3 class="text-lg font-semibold text-primary mb-4">Kata Kunci Populer (Word Cloud)</h3>
      <div class="flex items-center justify-center">
        <canvas id="wordCloud" class="w-full max-w-[1100px]" height="400"></canvas>
      </div>
    </div>

    <!-- Top Keywords per Sentiment -->
    <div class="bg-background-light p-6 rounded-lg shadow-soft mt-6">
      <h3 class="text-lg font-semibold text-primary mb-4"> Kata Kunci Dominan per Sentimen</h3>
      <div id="keywordSummary" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-700"></div>
    </div>

  </div>
</main>

<!-- ================= FOOTER ================= -->
<footer class="w-full border-t border-primary mt-10">
  <div class="max-w-7xl mx-auto py-4 px-4 text-center text-gray-500 text-sm">
    Â© 2025 Sean Daffa Damara â€“ Direktorat Data dan Kecerdasan Buatan
  </div>
</footer>

<!-- ================= SCRIPTS ================= -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-wordcloud@4"></script>


<script>
const colorMap = { Positif:"#28a745", Netral:"#007bff", Negatif:"#dc3545" };
let previousSummary = null; // Menyimpan hasil analisis sebelumnya

async function loadData() {
  try {
    // Pastikan path CSV sesuai lokasi file kamu
    const res = await fetch("tweets_ikn_labeled.csv");
    const text = await res.text();
    const parsed = Papa.parse(text, { header: true }).data;

    // Hanya ambil baris valid
    return parsed.filter(d => d.clean_text && d.Kategori && d.created_at);
  } catch (e) {
    console.error("Gagal memuat data:", e);
    return [];
  }
}

async function updateDashboard() {
  function updateKeywordSummary(data) {
    const sentiments = ["Positif", "Netral", "Negatif"];
    const colors = {
      Positif: { base: "green", icon: "sentiment_satisfied" },
      Netral: { base: "blue", icon: "sentiment_neutral" },
      Negatif: { base: "red", icon: "sentiment_dissatisfied" }
    };

    const container = document.getElementById("keywordSummary");
    container.innerHTML = "";

    const usedWords = new Set(); // untuk menyimpan kata yang sudah muncul di kategori sebelumnya

    sentiments.forEach(cat => {
      const texts = data.filter(d => d.Kategori === cat).map(d => d.clean_text || "");
      const words = texts.join(" ").toLowerCase().replace(/[^\w\s]/g, "").split(/\s+/);

      const freq = {};
      for (const w of words) {
        if (w.length > 3 && !usedWords.has(w)) freq[w] = (freq[w] || 0) + 1;
      }

      // Ambil 3 kata teratas yang belum pernah dipakai
      const topWords = Object.entries(freq)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);

      // Simpan ke daftar kata yang sudah dipakai agar tidak muncul di kategori berikutnya
      topWords.forEach(([w]) => usedWords.add(w));

      const color = colors[cat].base;
      const icon = colors[cat].icon;

      const html = `
        <div class="bg-${color}-50 border border-${color}-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 p-5 flex flex-col">
          <div class="flex items-center gap-2 mb-3">
            <span class="material-symbols-outlined text-${color}-500 text-xl">${icon}</span>
            <h4 class="font-semibold text-${color}-600 text-lg">${cat}</h4>
          </div>
          <ul class="text-gray-700 text-sm space-y-1">
            ${
              topWords.length > 0
                ? topWords
                    .map(
                      ([w, c]) => `
                      <li class="flex justify-between border-b border-gray-100 py-1">
                        <span class="font-medium capitalize">${w}</span>
                        <span class="text-gray-500">(${c})</span>
                      </li>`
                    )
                    .join("")
                : `<li class="text-gray-400 italic">Tidak ada data unik</li>`
            }
          </ul>
        </div>`;
      container.innerHTML += html;
    });
  }

  // === Helper untuk menyimpan baseline awal saat load pertama ===
  function initializeBaseline(data) {
    const counts = { Positif: 0, Netral: 0, Negatif: 0 };
    data.forEach(d => counts[d.Kategori]++);
    const total = data.length || 1;
    previousSummary = {
      Positif: (counts.Positif / total) * 100,
      Netral: (counts.Netral / total) * 100,
      Negatif: (counts.Negatif / total) * 100
    };
  }

  function generateInsights(currentData) {
    // --- Step 1: Group by date & category ---
    const grouped = {};
    currentData.forEach(d => {
      const date = (d.created_at || "").split(" ")[0];
      const cat = d.Kategori;
      if (!grouped[date]) grouped[date] = { Positif: 0, Netral: 0, Negatif: 0 };
      grouped[date][cat] = (grouped[date][cat] || 0) + 1;
    });

    const dates = Object.keys(grouped).sort();
    if (dates.length < 2) {
      console.warn("Data terlalu sedikit untuk membandingkan periode.");
      return;
    }

    // --- Step 2: Tentukan rentang awal & akhir (per hari / proporsional) ---
    let startDates, endDates;
    if (dates.length === 2) {
      startDates = [dates[0]];
      endDates = [dates[1]];
    } else {
      const cut = Math.floor(dates.length * 0.3) || 1;
      startDates = dates.slice(0, cut);
      endDates = dates.slice(-cut);
    }

    // --- Step 3: Hitung total per kategori pada periode awal & akhir ---
    const sumByPeriod = (dateList) => {
      const total = { Positif: 0, Netral: 0, Negatif: 0 };
      dateList.forEach(d => {
        if (grouped[d]) {
          total.Positif += grouped[d].Positif;
          total.Netral += grouped[d].Netral;
          total.Negatif += grouped[d].Negatif;
        }
      });
      return total;
    };

    const awal = sumByPeriod(startDates);
    const akhir = sumByPeriod(endDates);

    const totalAwal = awal.Positif + awal.Netral + awal.Negatif || 1;
    const totalAkhir = akhir.Positif + akhir.Netral + akhir.Negatif || 1;

    const pctAwal = {
      Positif: (awal.Positif / totalAwal) * 100,
      Netral: (awal.Netral / totalAwal) * 100,
      Negatif: (awal.Negatif / totalAwal) * 100
    };
    const pctAkhir = {
      Positif: (akhir.Positif / totalAkhir) * 100,
      Netral: (akhir.Netral / totalAkhir) * 100,
      Negatif: (akhir.Negatif / totalAkhir) * 100
    };

    // --- Step 4: Hitung perubahan ---
    const diff = {
      Positif: pctAkhir.Positif - pctAwal.Positif,
      Netral: pctAkhir.Netral - pctAwal.Netral,
      Negatif: pctAkhir.Negatif - pctAwal.Negatif
    };

    // --- Step 5: Update insight cards ---
    updateInsightCard("Positif", diff.Positif, "posChange", "posNote");
    updateInsightCard("Netral", diff.Netral, "netChange", "netNote");
    updateInsightCard("Negatif", diff.Negatif, "negChange", "negNote");

    // --- Step 6: Narasi otomatis ---
    const dom = document.getElementById("insightNarrative");
    let narasi = `
      Dari periode <b>${dates[0]}</b> hingga <b>${dates[dates.length - 1]}</b>, 
      terjadi perubahan pola persepsi masyarakat terhadap pembangunan Ibu Kota Nusantara. 
      Sentimen <b>positif</b> ${diff.Positif > 0 ? "meningkat" : diff.Positif < 0 ? "menurun" : "stabil"} 
      sebesar <b>${Math.abs(diff.Positif).toFixed(1)}%</b>, 
      <b>netral</b> ${diff.Netral > 0 ? "meningkat" : diff.Netral < 0 ? "menurun" : "stabil"} 
      sebesar <b>${Math.abs(diff.Netral).toFixed(1)}%</b>, 
      dan <b>negatif</b> ${diff.Negatif > 0 ? "meningkat" : diff.Negatif < 0 ? "menurun" : "stabil"} 
      sebesar <b>${Math.abs(diff.Negatif).toFixed(1)}%</b>. 
      Secara umum, hasil ini menggambarkan bahwa wacana publik 
      ${
        diff.Netral > 0
          ? "cenderung bergerak menuju arah yang lebih informatif dan faktual, dengan meningkatnya proporsi percakapan netral."
          : diff.Positif > diff.Negatif
          ? "didominasi oleh nada optimisme dan dukungan terhadap pembangunan IKN."
          : "masih menunjukkan adanya ruang peningkatan persepsi positif di masyarakat."
      }
    `;
    dom.innerHTML = narasi;
  }

  function updateInsightCard(label, value, valueId, noteId) {
    const elValue = document.getElementById(valueId);
    const elNote = document.getElementById(noteId);
    const sign = value >= 0 ? "+" : "-";
    elValue.textContent = `${sign}${Math.abs(value).toFixed(1)}%`;

    if (value > 0)
      elNote.textContent = `Sentimen ${label.toLowerCase()} meningkat dibanding periode sebelumnya`;
    else if (value < 0)
      elNote.textContent = `Sentimen ${label.toLowerCase()} menurun dibanding periode sebelumnya`;
    else
      elNote.textContent = `Sentimen ${label.toLowerCase()} stabil dibanding periode sebelumnya`;
  }

  const data = await loadData();
  if (!data || data.length === 0) return;

  // Ambil filter
  const selected = document.getElementById("sentimenFilter").value;
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;

  // Filter sesuai pilihan user
  const filtered = data.filter(d => {
    const kategori = (d.Kategori || "").trim().toLowerCase();
    const catOK = selected === "all" || kategori === selected.toLowerCase();

    // --- PATCH: parsing tanggal manual (lokal, aman) ---
    const dateStr = (d.created_at || "").split(" ")[0]; // ambil yyyy-mm-dd
    const date = new Date(dateStr + "T00:00:00");
    const startObj = start ? new Date(start + "T00:00:00") : null;
    const endObj = end ? new Date(end + "T23:59:59") : null;
    const dateOK =
      (!startObj || date >= startObj) && (!endObj || date <= endObj);
    // --- END PATCH ---

    return catOK && dateOK;
  });

  // Jika tidak ada data
  if (filtered.length === 0) {
    console.warn("Tidak ada data cocok dengan filter.");
  }

  renderGauges(filtered);
  renderCharts(filtered);
  generateWordCloud(filtered);
  updateKeywordSummary(filtered);

  // Jika pertama kali, inisialisasi baseline terlebih dahulu
  if (!previousSummary) {
    initializeBaseline(filtered);
  } else {
    generateInsights(filtered);
  }
}

// === GAUGES ===
function renderGauges(data) {
  const total = data.length || 1;
  const counts = { Positif: 0, Netral: 0, Negatif: 0 };

  // normalisasi kategori agar konsisten
  data.forEach(d => {
    const kategori = (d.Kategori || "").trim().toLowerCase();
    if (kategori === "positif") counts.Positif++;
    else if (kategori === "netral") counts.Netral++;
    else if (kategori === "negatif") counts.Negatif++;
  });

  const gauges = [
    { id: "pos", label: "Positif", icon: "sentiment_satisfied", color: "#28a745" },
    { id: "net", label: "Netral", icon: "sentiment_neutral", color: "#007bff" },
    { id: "neg", label: "Negatif", icon: "sentiment_dissatisfied", color: "#dc3545" },
  ];

  gauges.forEach(g => {
    const pct = ((counts[g.label] / total) * 100).toFixed(2);
    const dash = (pct / 100) * 283;
    const el = document.getElementById(`gauge-${g.id}`);
    el.innerHTML = `
      <div class="flex flex-col items-center justify-center w-full group transition-all duration-300">
        <div class="relative w-28 h-28 mb-2 transition-transform duration-300 group-hover:scale-[1.03]">
          <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" stroke="#f0f0f0" stroke-width="10" fill="none"/>
            <circle cx="50" cy="50" r="45"
              stroke="${g.color}"
              stroke-width="10"
              fill="none"
              stroke-linecap="round"
              stroke-dasharray="${dash} 283"
              style="transition: stroke-dasharray 1s ease;"
              class="gauge-stroke"
            />
          </svg>
          <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
            <span class="material-symbols-outlined text-4xl mb-1" style="color:${g.color}">${g.icon}</span>
            <span class="text-lg font-bold" style="color:${g.color}">${pct}%</span>
          </div>
        </div>
        <h3 class="text-base font-semibold text-gray-700 mt-1">${g.label}</h3>
      </div>`;
  });
}

// === CHARTS ===
let chartSentimen = null;
let chartBar = null;
let chartTrend = null;

function renderCharts(data) {
  const grouped = data.reduce((a, d) => {
    a[d.Kategori] = (a[d.Kategori] || 0) + 1;
    return a;
  }, {});
  const labels = Object.keys(grouped);
  const values = Object.values(grouped);

  // === 1. Hancurkan chart lama jika ada ===
  if (chartSentimen) chartSentimen.destroy();
  if (chartBar) chartBar.destroy();
  if (chartTrend) chartTrend.destroy();

  // === 2. DONUT CHART ===
  chartSentimen = new Chart(document.getElementById("chart-sentimen"), {
    type: "doughnut",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: labels.map(l => colorMap[l]),
        borderWidth: 2,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "bottom" },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const total = ctx.chart._metasets[0].total;
              const val = ctx.parsed;
              const pct = ((val / total) * 100).toFixed(1);
              return `${ctx.label}: ${val} (${pct}%)`;
            }
          }
        },
        datalabels: {
          color: "#ffffff",
          font: { weight: "bold", size: 16 },
          formatter: (value, ctx) => {
            const total = ctx.chart._metasets[0].total;
            const pct = ((value / total) * 100).toFixed(0);
            return pct + "%";
          }
        }
      },
    },
    plugins: [ChartDataLabels],
  });

  // === 3. BAR CHART ===
  chartBar = new Chart(document.getElementById("chart-bar"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: labels.map(l => colorMap[l]),
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false } },
        y: { beginAtZero: true, ticks: { stepSize: 10 } },
      },
    },
  });

  // === 4. LINE CHART: Tren Harian ===
  const groupedDates = {};
  data.forEach(d => {
    const dateStr = (d.created_at || "").split(" ")[0];
    const sent = d.Kategori;
    if (!groupedDates[dateStr]) groupedDates[dateStr] = { Positif: 0, Netral: 0, Negatif: 0 };
    groupedDates[dateStr][sent] = (groupedDates[dateStr][sent] || 0) + 1;
  });

  const dates = Object.keys(groupedDates).sort();

  const datasets = [
    {
      label: "Positif",
      data: dates.map(d => groupedDates[d].Positif),
      borderColor: colorMap["Positif"],
      backgroundColor: "rgba(40,167,69,0.1)",
      tension: 0.35,
      fill: false,
      pointRadius: 4,
      pointBackgroundColor: colorMap["Positif"],
    },
    {
      label: "Netral",
      data: dates.map(d => groupedDates[d].Netral),
      borderColor: colorMap["Netral"],
      backgroundColor: "rgba(0,123,255,0.1)",
      tension: 0.35,
      fill: false,
      pointRadius: 4,
      pointBackgroundColor: colorMap["Netral"],
    },
    {
      label: "Negatif",
      data: dates.map(d => groupedDates[d].Negatif),
      borderColor: colorMap["Negatif"],
      backgroundColor: "rgba(220,53,69,0.1)",
      tension: 0.35,
      fill: false,
      pointRadius: 4,
      pointBackgroundColor: colorMap["Negatif"],
    }
  ];

  chartTrend = new Chart(document.getElementById("chart-trend"), {
    type: "line",
    data: { labels: dates, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { position: "bottom" },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${ctx.formattedValue}`,
          },
        },
      },
      scales: {
        x: {
          title: { display: true, text: "Tanggal", color: "#333", font: { size: 12 } },
          ticks: { color: "#555" },
          grid: { display: false },
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: "Jumlah Tweet", color: "#333", font: { size: 12 } },
          ticks: { color: "#555" },
        },
      },
    },
  });
}

// === WORD CLOUD ===
async function generateWordCloud() {
  const response = await fetch("tweets_ikn_labeled.csv");
  const csvText = await response.text();
  const parsed = Papa.parse(csvText, { header: true });
  const data = parsed.data.filter(d => d.clean_text && d.clean_text.trim() !== "");

  if (data.length === 0) {
    console.log("Tidak ada data untuk ditampilkan.");
    return;
  }

  // Gabungkan semua teks
  const allText = data.map(d => d.clean_text).join(" ").toLowerCase();
  const words = allText.replace(/[^\w\s]/g, "").split(/\s+/);

  // Hitung frekuensi
  const freq = {};
  for (const w of words) {
    if (w.length < 3) continue;
    freq[w] = (freq[w] || 0) + 1;
  }

  // Ambil 100 kata teratas
  const sorted = Object.entries(freq)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 100)
    .map(([text, weight]) => ({ text, weight }));

  // Hitung bobot manual (supaya variasi besar kecil lebih mirip Streamlit)
  const max = Math.max(...sorted.map(w => w.weight));
  const min = Math.min(...sorted.map(w => w.weight));
  const scaled = sorted.map(w => ({
    text: w.text,
    weight: ((w.weight - min) / (max - min)) * 90 + 10, // range 10â€“100
  }));

  const wcCtx = document.getElementById("wordCloud");

  // Hapus chart sebelumnya jika ada
 
  wcCtx.chartInstance = new Chart(wcCtx, {
    type: "wordCloud",
    data: {
      labels: scaled.map(w => w.text),
      datasets: [{
        label: "Word Cloud",
        data: scaled.map(w => w.weight),
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
      },
      layout: {
        padding: 1,
      },
      elements: {
        word: {
          padding: 1,
          spiral: "rectangular",
          placementStrategy: "center",
          fontFamily: "Inter, sans-serif",
          minFontSize: 18,
          maxFontSize: 82,
          // === Fokus utama: scaling biar memenuhi canvas ===
          fit: true,
          size: (ctx) => ctx.raw * 2.5,  // sedikit perbesar ukuran relatif
          color: (ctx) => {
            const colors = [
              "#c7a74a", "#007bff", "#28a745", "#dc3545",
              "#1d4ed8", "#16a34a", "#a16207"
            ];
            return colors[Math.floor(Math.random() * colors.length)];
          },
          rotate: () => (Math.random() > 0.9 ? 90 : 0),
        },
      },
      // === Tambahan untuk memperbesar area plot ===
      scales: {
        x: { display: false, min: -100, max: 100 },
        y: { display: false, min: -100, max: 100 },
      },
    },
  });
}

  // === 6. Event bindings & inisialisasi tanggal otomatis ===
  window.addEventListener("DOMContentLoaded", async () => {
    const refreshBtn = document.getElementById("refreshBtn");
    const filter = document.getElementById("sentimenFilter");
    const startDate = document.getElementById("startDate");
    const endDate = document.getElementById("endDate");

    const allData = await loadData();

    if (allData.length > 0) {
      const allDates = allData
        .map(d => new Date(d.created_at))
        .filter(d => !isNaN(d));

      const minDate = new Date(Math.min(...allDates));
      const maxDate = new Date(Math.max(...allDates));

      const formatDate = (d) =>
        `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;

      const minStr = formatDate(minDate);
      const maxStr = formatDate(maxDate);

      startDate.value = minStr;
      endDate.value = maxStr;
      startDate.min = minStr;
      startDate.max = maxStr;
      endDate.min = minStr;
      endDate.max = maxStr;
    }

    // === Jalankan dashboard pertama kali ===
    await updateDashboard();

    // === Simulasikan klik tombol Perbarui Analisis otomatis ===
    setTimeout(() => {
      refreshBtn.click();
    }, 600); // jeda sedikit agar data & chart sudah render semua

    // === Event handler manual ===
    refreshBtn.addEventListener("click", updateDashboard);
    filter.addEventListener("change", updateDashboard);
    startDate.addEventListener("change", updateDashboard);
    endDate.addEventListener("change", updateDashboard);
  });
</script>
</body>
</html>